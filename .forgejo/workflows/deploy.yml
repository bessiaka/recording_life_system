name: Deploy to Production

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ… Ğ² Ğ²ĞµÑ‚ĞºĞµ main (push Ğ¸Ğ»Ğ¸ pull request)
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Application
    runs-on: alpine  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ alpine runner ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğµ

      - name: Setup environment
        run: |
          echo "ğŸ“¦ Setting up environment..."

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env.production ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
          if [ ! -f .env.production ]; then
            echo "Creating .env.production from example..."
            cp .env.example .env.production

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ production
            sed -i 's/ENVIRONMENT=development/ENVIRONMENT=production/' .env.production
            sed -i 's/HOST_IP=192.168.1.13/HOST_IP=192.168.1.72/' .env.production
            sed -i 's/HOST_NAME=desktop/HOST_NAME=server/' .env.production
            sed -i 's/BACKEND_PORT=8000/BACKEND_PORT=8003/' .env.production
            sed -i 's/FRONTEND_PORT=3000/FRONTEND_PORT=3003/' .env.production
          fi

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¸Ğ¼Ğ»Ğ¸Ğ½Ğº .env -> .env.production
          ln -sf .env.production .env

          echo "âœ… Environment configured"

      - name: Check for database reset
        id: check_db_reset
        run: |
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ„Ğ»Ğ°Ğ³Ğ° [reset-db]
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q "\[reset-db\]"; then
            echo "reset_db=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Database reset requested in commit message"
          else
            echo "reset_db=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No database reset requested"
          fi

      - name: Stop existing containers
        run: |
          echo "ğŸ›‘ Stopping existing containers..."
          docker compose -f docker-compose.yml --env-file=.env.production down || true
          echo "âœ… Containers stopped"

      - name: Reset database if requested
        if: steps.check_db_reset.outputs.reset_db == 'true'
        run: |
          echo "ğŸ—‘ï¸  Removing old database..."
          rm -f ./data/tasks.db
          echo "âœ… Database removed"

      - name: Create data directory
        run: |
          echo "ğŸ“ Creating data directory..."
          mkdir -p ./data
          echo "âœ… Data directory ready"

      - name: Build and start containers
        run: |
          echo "ğŸš€ Building and starting containers..."
          docker compose -f docker-compose.yml --env-file=.env.production up -d --build
          echo "âœ… Containers started"

      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10
          echo "âœ… Services should be ready"

      - name: Check container status
        run: |
          echo "ğŸ“Š Container status:"
          docker compose -f docker-compose.yml --env-file=.env.production ps

      - name: Show logs
        if: always()
        run: |
          echo "ğŸ“‹ Backend logs:"
          docker compose -f docker-compose.yml --env-file=.env.production logs backend --tail=50
          echo ""
          echo "ğŸ“‹ Frontend logs:"
          docker compose -f docker-compose.yml --env-file=.env.production logs frontend --tail=50

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo ""
          echo "ğŸŒ Application is available at:"
          echo "  - Frontend: http://192.168.1.72:3003"
          echo "  - Backend API: http://192.168.1.72:8003"
          echo "  - API Docs: http://192.168.1.72:8003/docs"
