name: Deploy to Production

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ push –≤ main –∏–ª–∏ manual trigger
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all containers'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: alpine

    steps:
      # 1. Checkout –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: Environment check
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          echo "Node.js: $(node --version)"
          echo "Python: $(python --version)"
          echo "Docker: $(docker --version)"
          echo "Docker Compose: $(docker compose version)"
          echo "Git: $(git --version)"

      # 3. –í–∞–ª–∏–¥–∞—Ü–∏—è Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
      - name: Validate Docker Compose config
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose.yml..."
          docker compose -f docker-compose.yml config > /dev/null
          echo "‚úÖ Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞"

      # 4. –°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π
      - name: Deploy to production
        run: |
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –≤ production..."

          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker compose --env-file=.env.production down || true

          # –°–±–æ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤
          echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
          docker compose --env-file=.env.production build --no-cache

          # –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker compose --env-file=.env.production up -d

          # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 10

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker compose --env-file=.env.production ps

      # 5. Health check
      - name: Health check
        run: |
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          RUNNING_CONTAINERS=$(docker compose --env-file=.env.production ps --services --filter "status=running" | wc -l)
          TOTAL_SERVICES=$(docker compose --env-file=.env.production ps --services | wc -l)

          echo "–ó–∞–ø—É—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: $RUNNING_CONTAINERS –∏–∑ $TOTAL_SERVICES"

          if [ "$RUNNING_CONTAINERS" -eq "$TOTAL_SERVICES" ]; then
            echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ùå –ù–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
            docker compose --env-file=.env.production logs --tail=50
            exit 1
          fi

      # 6. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
      - name: Cleanup old images
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö Docker –æ–±—Ä–∞–∑–æ–≤..."
          docker image prune -f
          echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

      # 7. –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
      - name: Deployment summary
        run: |
          echo "========================================="
          echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY"
          echo "========================================="
          echo ""
          echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
          docker compose --env-file=.env.production ps
          echo ""
          echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞:"
          docker system df
          echo ""
          echo "üéØ Deployment timestamp: $(date)"
          echo "========================================="
